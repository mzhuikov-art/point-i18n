# Исправления для WebStorm Plugin

## Проблема
В расширении для WebStorm не работало:
1. Отображение переводов в коде (inline decorations)
2. Отображение переводов при hover

## Причины
1. **Неправильная регистрация провайдеров** - в `plugin.xml` провайдеры были зарегистрированы с `language=""`, что не работает в IntelliJ Platform
2. **Отсутствие Inlay Hints Provider** - использовался только LineMarkerProvider, который не подходит для inline decorations
3. **Недостаточная поддержка паттернов** - парсер ключей поддерживал ограниченный набор паттернов

## Внесенные изменения

### 1. plugin.xml
- ✅ Исправлена регистрация провайдеров с указанием конкретных языков (JavaScript, TypeScript, Vue, JSX Harmony)
- ✅ Добавлена зависимость на JavaScript плагин
- ✅ Зарегистрирован новый InlayHintsProvider для inline decorations

### 2. PointI18nHoverProvider.java
- ✅ Полностью переписан с использованием AbstractDocumentationProvider
- ✅ Добавлены множественные стратегии поиска ключей на позиции курсора
- ✅ Улучшено форматирование HTML документации с использованием DocumentationMarkup
- ✅ Добавлена таблица переводов для всех языков (ru, en, uz)

### 3. PointI18nLineMarkerProvider.java
- ✅ Переписан с наследованием от LineMarkerProviderDescriptor
- ✅ Улучшена логика определения PSI элементов
- ✅ Добавлена поддержка иконок и tooltips

### 4. PointI18nInlayHintsProvider.java (новый)
- ✅ Создан новый провайдер для inline hints (аналог VSCode decorations)
- ✅ Отображает переводы прямо в коде рядом с ключами
- ✅ Поддерживает все основные языки (JavaScript, TypeScript, Vue)

### 5. I18nKeyParser.java
- ✅ Расширена поддержка паттернов:
  - `$t('key')`
  - `i18n.t('key')`
  - `t('key')`
  - `useI18n().t('key')`
  - `this.$t('key')`
  - `v-t="'key'"` (Vue директива)
  - `keypath="key"` (i18n-t компонент)
- ✅ Добавлена валидация ключей (kebab-case формат)
- ✅ Улучшена обработка ошибок

### 6. ToggleDecorationsAction.java
- ✅ Обновлен для работы с InlayHintsProvider
- ✅ Добавлено обновление всех типов decorations при переключении

### 7. Ресурсы
- ✅ Добавлена иконка `/icons/globe.svg`

## Как работает

### Hover
1. Пользователь наводит курсор на ключ локализации (например, `$t('home-title')`)
2. HoverProvider перехватывает событие
3. Ищется ключ на позиции курсора используя несколько стратегий
4. Загружаются переводы для всех локалей (ru, en, uz)
5. Отображается таблица с переводами в виде HTML документации

### Inline Decorations
1. При открытии файла InlayHintsProvider анализирует код
2. Находит все ключи локализации в файле
3. Для каждого ключа загружает перевод из кэша
4. Добавляет inline hint с переводом после ключа
5. Hints автоматически обновляются при изменении кода

### Line Markers
1. LineMarkerProvider добавляет иконки в gutter рядом с ключами
2. При наведении на иконку показывается tooltip с переводом
3. Иконки помогают быстро найти все ключи локализации в файле

## Тестирование

### Сборка плагина
```bash
cd src/ide/webstorm
./gradlew buildPlugin
```

### Установка
1. Соберите плагин (выше)
2. В WebStorm: Settings → Plugins → ⚙️ → Install Plugin from Disk...
3. Выберите файл из `build/distributions/point-i18n-1.1.6.zip`
4. Перезапустите WebStorm

### Проверка работы
1. Откройте файл с ключами локализации (например, `.vue`, `.ts`, `.js`)
2. Убедитесь, что токен настроен (Tools → Configure API Base URL)
3. Проверьте hover на ключах локализации - должна появиться таблица с переводами
4. Проверьте inline hints - рядом с ключами должны отображаться переводы
5. Проверьте line markers - в gutter должны быть иконки глобуса

### Отладка
1. Логи плагина можно найти в Help → Show Log in Finder
2. Ищите сообщения от `PointI18nHoverProvider`, `PointI18nInlayHintsProvider`, `PointI18nLineMarkerProvider`
3. Логи содержат информацию о найденных ключах и загруженных локалях

## Возможные проблемы

### Не работает hover
- Проверьте, что токен установлен
- Проверьте логи на наличие ошибок загрузки локалей
- Убедитесь, что курсор находится именно на ключе локализации

### Не работают inline decorations
- Проверьте, что InlayHints включены в Settings → Editor → Inlay Hints
- Попробуйте переключить decorations через Tools → Toggle I18n Decorations
- Перезапустите WebStorm

### Не находятся ключи
- Проверьте формат ключей (должны быть в kebab-case)
- Убедитесь, что используется поддерживаемый паттерн (`$t`, `t`, `i18n.t` и т.д.)
- Проверьте, что файл имеет правильный тип (JavaScript, TypeScript, Vue)

## Дальнейшие улучшения

- [ ] Добавить support для JSX/TSX
- [ ] Добавить поддержку интерполяции в ключах
- [ ] Добавить quick fix для создания отсутствующих переводов
- [ ] Добавить автодополнение ключей
- [ ] Добавить rename refactoring для ключей
- [ ] Оптимизировать производительность для больших файлов

